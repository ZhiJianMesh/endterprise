[
{
    "name" : "list",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker":"RBAC",
    "feature":"hr",
    "comment" : "查询雇员身上挂的资产",

    "request": [
        {"name":"uid", "type":"int", "must":true, "min":1, "comment":"用户id"}
    ],
    
    "process" : [
        {
            "name" : "list_res",
            "type" : "rdb",
            "db":"hr",
            "sqls" : [{
                "name":"list",
                "metas" : "each",
                "merge" : false,
                "multi" : true,
                "sql" : "select start,rid,cfmAt,code,skuName
                 from resource where uid=@{uid}"
            }]
        }
    ]
},

{
    "name" : "my",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "查询雇员自己身上挂的资产",
    
    "process" : [
        {
            "name" : "list_res",
            "type" : "rdb",
            "db":"hr",
            "sqls" : [{
                "name":"list",
                "metas" : "each",
                "merge" : false,
                "multi" : true,
                "sql" : "select start,rid,cfmAt,code 
                    from resource where uid=@{#tokenCaller}"
            }]
        }
    ]
},

{
    "name" : "add",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker":"RBAC",
    "feature":"hr",
    "comment" : "在雇员身上挂资产，通常是仓库管理员将新资产转给某个员工",

    "request": [
        {"name":"uid", "type":"int", "must":true, "min":1, "comment":"用户id"},
        {"name":"rid", "type":"int", "must":true, "comment":"资产ID"},
        {"name":"skuName", "type":"string", "must":true, "comment":"SKU名称"},
        {"name":"code", "type":"string", "must":true, "comment":"资产编号"}
    ],

    "process" : [
        {
            "name" : "add_res",
            "type" : "rdb",
            "db":"hr",
            "sqls" : [
                "insert into resource(uid,start,rid,code,skuName)
                 select uid,@{NOW|unit60000},@{rid},'@{code}','@{skuName}'
                  from employee where uid=@{uid}" //使用select是为了确保employee存在
            ]
        },
        {
            "name" : "save_res_log",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                //资产先挂在添加人身上，防止历史空白
                "insert into reslog(rid,start,end,uid)
                 values(@{rid},@{NOW|unit60000},2147483648,@{#tokenCaller})"
            ]
        }
    ]
},

{
    "name" : "confirm",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "雇员确认资产挂帐",

    "request": [
        {"name":"rid", "type":"int", "must":true, "comment":"资产ID"}
    ],
    
    "process" : [
        {
            "name" : "cfm_res",
            "type" : "rdb",
            "db":"hr",
            "sqls" : [
                "update resource set cfmAt=@{NOW|unit60000}
                 where rid=@{rid} and uid=@{#tokenCaller} and cfmAt=0"
            ]
        },
        {
            "name" : "save_res_log",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                "update reslog set end=@{NOW|unit60000}
                where rid=@{rid} and end=2147483648", //结束最近的挂账人挂账历史

                //插入新的挂账记录
                "insert into reslog(rid,start,end,uid)
                 values(@{rid},@{NOW|unit60000},2147483648,@{#tokenCaller})"
            ]
        }
    ]
},

{
    "name" : "remove",
    "method" : "DELETE",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker":"RBAC",
    "feature":"resource",
    "comment" : "删除资产挂账。在资产报废的情况下，执行此命令",

    "request": [
        {"name":"rid", "type":"int", "must":true, "comment":"资产ID"}
    ],
    
    "process" : [
        {
            "name" : "remove_resource",
            "type" : "rdb",
            "db":"hr",
            "sqls" : [
                "delete from resource where rid=@{rid}" //删除挂账
            ]
        },
        {
            "name" : "end_res_log",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                "update reslog set end=@{NOW|unit60000}
                where rid=@{rid} and end=2147483648" //结束最近的挂账人挂账历史
            ]
        }
    ]
},

{
    "name" : "moveTo",
    "method" : "PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "将自己的资产转移给其他人。对方未确认时，reslog仍然记录在原用户名下，可拒绝",

    "request": [
        {"name":"rid", "type":"int", "must":true, "comment":"资产ID"},
        {"name":"receiver", "type":"int", "must":true, "min":1, "comment":"接收用户id"}
    ],
    
    "process" : [
        {
            "name" : "move_resource",
            "type" : "rdb",
            "db":"hr",
            "sqls" : [
                "update resource set uid=@{receiver},cfmAt=0
                  where rid=@{rid} and uid=@{#tokenCaller}"
            ]
        }
    ]
},
{
    "name" : "reject",
    "method" : "PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "拒绝资产转移",

    "request": [
        {"name":"rid", "type":"int", "must":true, "comment":"资产ID"}
    ],
    
    "process" : [
        {
            "name" : "get_original_uid",
            "type" : "rdb",
            "db":"log",
            "sqls" : [{
                "name":"original_uid",
                "metas" : "each",
                "merge" : true,
                "multi" : false,
                "sql" : "select uid,start from reslog
                     where rid=@{rid} and end=2147483648"
            }]
        },
        {
            "name" : "reject_resource",
            "type" : "rdb",
            "db":"hr",
            "sqls" : [ //还回去，只有未确认的才可以还回
                "update resource set uid=@{!uid},cfmAt=@{!start}
                  where rid=@{rid} and uid=@{#tokenCaller} and cfmAt=0"
            ]
        }
    ]
}
]