[
{
    "name" : "apply",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "APP-ihr",
    "comment" : "申请付薪，如果已经出现了，则在原有基础上加减",
    
    "request": [
        {"name":"uid", "type":"int", "must":true, "comment":"开始生效时间，UTC分钟"},
        {"name":"month", "type":"int", "must":true, "comment":"从1970.1至今的月份数"},
        {"name":"account", "type":"string", "must":true, "comment":"帐号，冗余字段"},
        {"name":"list", "type":"object", "list":true, "must":true, "props":[
            {"name":"type", "type":"string", "must":true,"comment":"类型",
             "options":["SALARY","SUBSIDY","EXPENSE","TAX","BONUS","SHARE","SECURITY0","SECURITY1"]},
            {"name":"val", "type":"double", "must":true, "comment":"金额"}
        ]},
        {"name":"cmt", "type":"string", "must":false, "default":"", "comment":"描述"}
    ],
    
    "process" : [
        {
            "name" : "add_salary_apply",
            "type" : "rdb",
            "db":"log",
            "sqls" : ["js:
                 var sqls=['insert into salaries(uid,month,type,val) values'];
                 var list=@{list};
                 var i=0;
                 for(var l of list) {
                    if(i>0)sqls.push(',');
                    sqls.push(`(@{uid},@{month},'`, l.type, `',`, l.val, ')');
					i++;
                 }
                 sqls.push(';');
                 sqls.push(`insert into salary(uid,month,applyAt,account,cmt) values(
                        @{uid},@{month},@{NOW|unit60000},'@{account}','@{cmt}');`)
                 DB.sql(sqls.join(''));
             "]
        },
        {
            "name" : "add_salary_balance",
            "type" : "rdb",
            "db":"finance",
            "sqls" : ["js://报销与补贴都计算到工资中
                 var total=0;
                 var list=@{list};
                 for(var l of list) {
                    total+=l.val;
                 }
                 DB.sql('update balance set val=val+' + total + ` where type='CDEBT_SALARY'`);
            "]
        }
    ]
},
{
    "name" : "confirm",
    "method" : "PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker" : "RBAC",
    "feature" : "finance",
    "comment" : "确认付薪申请，在支付过后调用",
    
    "request": [
        {"name":"uid", "type":"int", "must":true, "comment":"开始生效时间，UTC分钟"},
        {"name":"month", "type":"int", "must":true, "comment":"从1970.1至今的月份数"},
        {"name":"mode", "type":"string", "must":true, "options":["BANK","CASH","WX","ALIP"], "comment":"支付方式"}
    ],

    "process" : [
        {
            "name" : "cofirm_salary_apply",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                {
                    "expected":{"num":1,"errorCode":111,"errorInfo":"no right"},
                    "sql":"update salary set
                        payAt=@{NOW|unit60000},
                        cfmAcc='@{#tokenAcc}',
                        state='OK',
                        mode='@{mode}'
                    where uid=@{uid} and month=@{month}
                     and state='WAIT' and payAt<=0"
                },
                {
                    "name" : "salary_val",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "sql" : "select sum(val) salary from salaries
                         where uid=@{uid} and month=@{month}"
                }
            ]
        },
        {
            "name" : "update_balance",
            "type" : "rdb",
            "db" : "finance",
            "comment" : "从公司现金中扣除工资，并减少待付工资",
            "sqls" : [
                //只有确认付款后，再确认项目工资分摊，确认之后删除掉分摊明细
                {
                    "name" : "shares",
                    "metas" : "each",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select pid,ratio from salaryshare where uid=@{uid} and month=@{month}"
                },
                
                "js:var shares=@[!shares];
                    var sqls=[];
                    var v;
                    for(var s of shares) {
                        v=(s.ratio*@{!salary}).toFixed(2);
                        sqls.push('update prjreport set salary=salary+', v, ' where pid=', s.pid, ';');
                    }
                    sqls.push('delete from salaryshare where uid=@{uid} and month=@{month}');
                    DB.sql(sqls.join(''));
                ",
            
                "update balance set val=val-@{!salary} where type='CUR_CASH'",
                "update balance set val=val-@{!salary} where type='CDEBT_SALARY'"
            ]
        }
    ],
    "response":[]
},

{
    "name" : "list",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker" : "RBAC",
    "feature":"finance",
    "comment" : "查询付薪申请记录",

    "request": [
        {"name":"month", "type":"int", "must":true, "comment":"从1970.1至今的月份数"},
        {"name":"offset", "type":"int", "must":true, "comment":"偏移"},
        {"name":"num", "type":"int", "must":true, "comment":"数量"},
        {"name":"state", "type":"string", "must":false, "options":["OK","WAIT"], "comment":"需要查询的状态"}
    ],
 
    "process" : [
        {
            "name" : "list_salaries",
            "type" : "rdb",
            "db" : "log",
            "sqls" : [
                {
                    "name" : "list",
                    "metas" : "each",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select S.uid,S.applyAt,S.account,S.cmt,
                          B.bank,B.account bankAcc,B.name
                         from salary S, bankacc B
                      where S.month=@{month} @{IFVALID|state, `and S.state='`, state, `'`}
                        and B.id=S.uid and B.type='EMPL'
                      ORDER by S.uid
                      LIMIT @{num} OFFSET @{offset}"
                },
                {
                    "name" : "items",
                    "metas" : "each",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select S.uid,SS.type,SS.val
                       from salary S,salaries SS
                      where S.uid in(@[LIST|!list,``,`uid`])
                        and S.month=@{month} @{IFVALID|state, `and S.state='`, state, `'`}
                        and SS.uid=S.uid and SS.month=@{month}
                    "
                }
            ]
        }
    ]
},

{
    "name" : "get",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker" : "RBAC",
    "feature":"admin",
    "comment" : "查询某个员工的付薪申请详情",
    
    "request": [
        {"name":"uid", "type":"int", "must":true, "comment":"开始生效时间，UTC分钟"},
        {"name":"month", "type":"int", "must":true, "comment":"从1970.1至今的月份数"}
    ],
            
    "process" : [
        {
            "name" : "get_salary",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                {
                    "name" : "salary",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "sql" : "select S.state,S.mode,S.applyAt,S.payAt,S.account,
                            S.cfmAcc,S.cmt,B.bank,B.account bankAcc,B.name
                        from salary S,bankacc B
                     where S.uid=@{uid} and S.month=@{month}
                       and B.id=@{uid} and B.type='EMPL'"
                },
                {
                    "name" : "items",
                    "metas" : "kv",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select type,val from salaries where uid=@{uid} and month=@{month}"
                }
            ]
        }
    ]
},
{
    "name" : "remove",
    "method" : "DELETE",
    "property" : "private",
    "tokenChecker" : "APP-ihr",
    "comment" : "删除付薪记录，未确认支付的才可以删除",
    
    "request": [
        {"name":"uid", "type":"int", "must":true, "comment":"开始生效时间，UTC分钟"},
        {"name":"month", "type":"int", "must":true, "comment":"从1970.1至今的月份数"}
    ],

    "process" : [
        {
            "name" : "rmv_salary_item",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                {
                    "name" : "salary_val",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "sql" : "select sum(val) val from salaries
                         where uid=@{uid} and month=@{month}"
                },
				//只删除发薪申请。不能同时删除项目分摊记录，因为后面还可能再次提交发薪申请
				{
    				"expected" : {"num":1, "errorCode":111, "errorInfo":"no right"},
                    "sql": "delete from salary
                         where uid=@{uid} and month=@{month}
                          and state='WAIT' and payAt=0"
                }
            ]
        },
        {
            "name" : "rmv_salary_balance",
            "type" : "rdb",
            "db" : "finance",
            "sqls" : [ //扣除待发薪
                "update balance set val=val-@{!val} where type='CDEBT_SALARY'"
            ]
        }
    ]
},

{
    "name" : "download",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker" : "RBAC",
    "feature":"finance",
    "comment" : "查询付薪申请记录",

    "request": [
        {"name":"month", "type":"int", "must":true, "comment":"从1970.1至今的月份数"}
    ],
 
    "process" : [
        {
            "name" : "list_salaries",
            "type" : "rdb",
            "db" : "log",
            "sqls" : [
                {
                    "name" : "list",
                    "metas" : "kv",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select S.uid,S.account,B.name,
                          B.bank,B.account bankAcc,B.idno
                         from salary S, bankacc B
                      where S.month=@{month} and S.state='OK'
                        and B.id=S.uid and B.type='EMPL'
                      ORDER by S.uid"
                },
                {
                    "name" : "items",
                    "metas" : "none",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select uid,type,val from salaries where month=@{month}"
                }
            ]
        }
    ],
    "response" : {
        "type":"XLSX",
        "template":"/conf/month_salaries.zip",
        "saveAs":"@{NOW|'yyyyMM'}_salaries.xlsx"
    }
}
]