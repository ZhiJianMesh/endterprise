[
{
    "name": "create",
    "method":"POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment":"创建服务记录，需要在电子流中审批",

    "request": [
        {"name":"customer", "type":"int", "must":true, "min":1, "comment":"客户id"},
        {"name":"order", "type":"int", "must":true, "min":0, "comment":"订单id，无订单，可传0"},
        {"name":"comment", "type":"string", "must":true, "min":1, "max":1000, "comment":"描述"}
    ],

    "process" : [
        {"macro": "has_right", "#DID#":"@{customer}", "#TYPE#":"CU",
         "comment":"拥有客户查看权限就可以创建服务记录，比如客服"},
        {"macro": "has_right", "#DID#":"@{order}", "#TYPE#":"OD", "when":"@{CONDITION|order,'i.!=',0}",
         "comment":"拥有订单查看权限就可以创建服务记录，比如客服"},
        {
            "name" : "get_order_customer_info",
            "type" : "dataexists",
            "when" : "@{order}!=0",
            "db": "crm",
            "errorCode":4001,
            "errorInfo":"invalid customer or order",
            "sql" : "select * from orders
                 where id=@{order} and customer=@{customer}"
        },
        {
            "name":"get_service_id",
            "type" : "var",
            "vars":{
                "serviceId":"@{SEQUENCE|i,'service'}"
            }
        },
        {
            "name" : "create_service",
            "type" : "rdb",
            "db": "crm",
            "sqls" : [
                "insert into services(id,customer,ord,createAt,creator,cmt)
                 values(@{serviceId},@{customer},@{order},@{NOW|unit60000},
                 '@{#tokenAcc}','@{comment}')"
            ]
        }
    ],
    "response":[]
},

{
    "name": "remove",
    "method":"DELETE",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment":"填写人删除服务记录",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":1, "comment":"服务id"}
    ],

    "process" : [{
        "name" : "remove",
        "type" : "rdb",
        "db": "crm",
        "sqls" : [
            "delete from service where id=@{id}
             and creator='@{#tokenAcc}' and state<>'OVER'"
        ]
    }],
    "response":[]
},

{
    "name": "setComment",
    "method":"PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment":"修改服务备注信息",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"服务id"},
        {"name":"comment", "type":"string", "must":true, "min":1, "max":1000, "comment":"备注"}
    ],

    "process" : [
        {
            "name" : "set",
            "type" : "rdb",
            "db": "crm",
            "sqls" : [
                "update services set cmt='@{comment}'
                 where id=@{id} and creator='@{#tokenAcc}' and state<>'OVER'"
            ]
        }
    ]
},

{
    "name": "over",
    "method":"PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment":"结束服务，在部分场景下，只有结束的服务才能作为绩效",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"服务id"}
    ],

    "process" : [
        {
            "name" : "set",
            "type" : "rdb",
            "db": "crm",
            "sqls" : [
                "update services set state='OVER'
                 where id=@{id} and creator='@{#tokenAcc}' and state<>'OVER'"
            ]
        }
    ]
},

{
    "name": "list",
    "method":"GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment":"客户订单下面所有可见的服务记录，如客户尚无订单，订单id传0",
            
    "request": [
        {"name":"customer", "type":"int", "must":true, "min":1, "comment":"客户id，冗余字段，便于查询"},
        {"name":"order", "type":"int", "must":false, "min":0, "comment":"订单id"},
        {"name":"offset", "type":"int",  "must":true, "min":0, "comment":"偏移"},
        {"name":"num", "type":"int",  "must":true, "min":1, "default":10, "comment":"返回行数"}
    ],

    "process" : [
        {
            "name" : "get_services",
            "type" : "rdb",
            "db": "crm",
            "sqls" : [
                {
                    "name":"services",
                    "metas" : "each",
                    "multi":true,
                    "sql":"select id,creator,createAt,state from services
                      where customer=@{customer}
                      @{IFVALID|order,` and ord=`, order}
                      order by createAt
                     LIMIT @{num} OFFSET @{offset}"
                },
                {
                    "name":"total",
                    "metas" : "each",
                    "multi":false,
                    "merge":true,
                    "sql":"select count(*) total from services
                     where customer=@{customer} @{IFVALID|order,` and ord=`, order}"
                }
            ]
        }
    ]   
},
{
    "name": "all",
    "method":"GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker" : "RBAC",
    "feature":"admin",
    "comment":"所有服务记录",
            
    "request": [
        {"name":"start", "type":"int", "must":true, "min":1, "comment":"开始时间，UTC分钟"},
        {"name":"end", "type":"int", "must":true, "min":1, "comment":"结束时间，UTC分钟"},
        {"name":"state", "type":"string", "must":false, "options":["RUN","OVER"], "comment":"服务状态"},
        {"name":"offset", "type":"int",  "must":true, "min":0, "comment":"偏移"},
        {"name":"num", "type":"int",  "must":true, "min":1, "default":10, "comment":"返回行数"}
    ],

    "process" : [
        {
            "name" : "get_services",
            "type" : "rdb",
            "db": "crm",
            "sqls" : [
                {
                    "name":"services",
                    "metas" : "each",
                    "multi":true,
                    "sql":"select id,creator,createAt,state from services
                      where createAt>@{start} and createAt<@{end}
                        @{IFVALID|state, ` and state='`, state, `'`}
                         order by createAt desc
                     LIMIT @{num} OFFSET @{offset}"
                },
                {
                    "name":"total",
                    "metas" : "each",
                    "multi":false,
                    "merge":true,
                    "sql":"select count(*) total from services
                       where createAt>@{start} and createAt<@{end}
                        @{IFVALID|state, ` and state='`, state, `'`}"
                }
            ]
        }
    ]   
},
{
    "name": "my",
    "method":"GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment":"所有我的服务记录",
            
    "request": [
        {"name":"state", "type":"string", "must":false, "options":["RUN","OVER"], "comment":"服务状态"},
        {"name":"offset", "type":"int",  "must":true, "min":0, "comment":"偏移"},
        {"name":"num", "type":"int",  "must":true, "min":1, "default":10, "comment":"返回行数"}
    ],

    "process" : [
        {
            "name" : "get_services",
            "type" : "rdb",
            "db": "crm",
            "sqls" : [
                {
                    "name":"services",
                    "metas" : "cols",
                    "multi":true,
                    "sql":"select s.id,s.createAt,s.state,
                        s.customer,c.name cname,o.skuName
                       from services s,customers c,orders o
                      where s.creator='@{#tokenAcc}'
                       @{IFVALID|state, ` and s.state='`, state, `'`}
                        and c.id=s.customer and o.id=s.ord
                        order by s.createAt desc
                     LIMIT @{num} OFFSET @{offset}"
                },
                {
                    "name":"total",
                    "metas" : "each",
                    "multi":false,
                    "merge":true,
                    "sql":"select count(*) total from services 
                    where creator='@{#tokenAcc}'
                    @{IFVALID|state, ` and state='`, state, `'`}"
                }
            ]
        }
    ]   
},
{
    "name": "detail",
    "method":"GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment":"服务记录详情",
            
    "request": [
        {"name":"id", "type":"int", "must":true, "min":1, "comment":"订单id"}
    ],

    "process" : [
        {
            "name" : "get_service_detail",
            "type" : "rdb",
            "db": "crm",
            "sqls" : [{
                "name" : "detail",
                "metas" : "each",
                "multi" : false,
                "merge" : true,
                "sql" : "select s.customer,s.ord,s.creator,s.createAt,s.cmt 'comment',s.state,
                            c.name cname,s.customer,o.skuName
                         from services s,customers c,orders o
                       where s.id=@{id} and c.id=s.customer and o.id=s.ord"
            }]
        },
        {"macro": "has_right", "#DID#":"@{!customer}", "#TYPE#":"CU"},
        {"macro": "has_right", "#DID#":"@{!ord}", "#TYPE#":"OD", "when":"@{CONDITION|!ord,'i.!=',0}"}
    ]
}
]