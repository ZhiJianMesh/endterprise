[
{
    "name": "listByFac",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"按工厂查询出库单",

    "request": [
        {"name":"factory", "type":"int", "must":true, "min":0, "comment":"工厂ID"},
        {"name":"offset", "type":"int", "must":true, "min":0, "comment":"偏移"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"返回行数"}
    ],

    "process" : [
        {
            "name" : "list_outbound",
            "type" : "rdb",
            "db": "log",
            "sharding":"@{NOW|`yyyy`}",
            "sqls" : [{
                "name" : "list",
                "metas" : "each",
                "multi" : true,
                "merge" : false,
                "sql":"select id,purId,expDate,state,type,tranNo,applicant,applyCmt,purId,prjName
                        from outbound where factory=@{factory}
                     order by type,expDate desc
                     LIMIT @{num} OFFSET @{offset}"
            }]
        }
    ]
},

{
    "name": "getByTranNo",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"按入库单号查询入库单，提货时查询。
        按年度分库，分库的状态影响查询结果，尽量将最近几年的放在同一个库中",

    "request": [
        {"name":"factory", "type":"int", "must":true, "min":0, "comment":"工厂ID，用于分库"},
        {"name":"tranNo", "type":"string", "must":true, "min":0, "comment":"运单号"},
        {"name":"type", "type":"string", "must":true, "options":["INN","EXT"], "comment":"发货类型"}
    ],

    "process" : [
        {
            "name" : "list_outbound",
            "type" : "rdb",
            "db": "log",
            "sharding":"@{NOW|`yyyy`}",
            "sqls" : [{
                "name" : "list",
                "metas" : "each",
                "multi" : true,
                "merge" : false,
                "sql":"select id,purId,expDate,state,type,tranNo,applicant,applyCmt,purId
                     from outbound where tranNo='@{tranNo}' and type='@{type}'"
            }]
        }
    ]
},
{
    "name": "outlist",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"出库sku列表",

    "request": [
        {"name":"purId", "type":"int", "must":true, "min":0, "comment":"采购单ID"}
    ],

    "process" : [
        {
            "name" : "get_outlist",
            "type":"rdb",
            "db":"log",
            "sharding":"@{NOW|`yyyy`}",
            "sqls":[{
                "name" : "list",
                "metas" : "each",
                "multi" : true,
                "merge" : false,
                "sql" : "select sku,num,no from outlist where purId=@{purId}"
            }]
        }
    ]
},
{
    "name": "start",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"开始执行资源出库，设置运单号与备注，在执行shipOut之前调用",

    "request": [
        {"name":"factory", "type":"int", "must":true, "min":0, "comment":"工厂ID，用于分库"},
        {"name":"purId", "type":"int", "must":true, "min":0, "comment":"采购申请id"},
        {"name":"tranNo", "type":"string", "must":true, "min":1, "comment":"外部运单号或内部提货单号"},
        {"name":"cmt", "type":"string", "must":true, "min":1, "comment":"备注"}
    ],

    "process" : [
        {
            "name" : "save_outbound",
            "type" : "rdb",
            "db": "log",
            "sharding":"@{NOW|yyyy}",
            "sqls" : [
                "update outbound set
                    tranNo='@{tranNo}',
                    cmt='@{cmt}',
                    outDate=@{NOW|unit60000},
                    execAcc='@{#tokenAcc}',
                    state='TRAN' -- 运输中
                  where purId=@{purId} and state='WAIT'"
            ]
        }
    ]
},

{
    "name": "shipOut",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"执行资源出库",

    "request": [
        {"name":"factory", "type":"int", "must":true, "min":0, "comment":"工厂ID，用于分库"},
        {"name":"purId", "type":"int", "must":true, "min":0, "comment":"采购单ID"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"出库数量"},
        {"name":"no", "type":"string", "must":true, "min":1, "comment":"出库资产编号"}
    ],

    "process" : [
        {
            "name" : "get_resource_sku",
            "type" : "rdb",
            "db": "inventory",
            "sharding":"@{factory}",
            "sqls" : [{
                "name" : "get_sku",
                "metas" : "each",
                "multi" : false,
                "merge" : true,
                "sql":"select sku,num from inventory where no='@{no}' and num>=@{num}"
            }]
        },
        {
            "name" : "save_outlist",
            "type" : "rdb",
            "db": "log",
            "sharding":"@{NOW|yyyy}",
            "sqls" : [
                "insert into outlist(purId,no,sku,num)
                 values(@{purId},'@{no}',@{!sku},@{num})"
            ]
        },
        {
            "name" : "update_outbound",
            "type" : "rdb",
            "db": "inventory",
            "sharding":"@{factory}",
            "when":"@{CONDITION|num,'i.<',!num}",
            "sqls" : [
                "update inventory set num=num-@{num} where no='@{no}'",
                "delete from inventory where no='@{no}' and num=0"
            ]
        },
        {
            "name" : "update_resource_state",
            "type" : "rdb",
            "db": "resource",
            "when":"@{CONDITION|num,'i.==',!num}", //resource中可能不存在，因为零件不计入resource
            "sharding" : "@{ABSHASH|no}",
            "sqls" : [
                "update resource set state='NONE' where no='@{no}'"
            ]
        }
    ]
},
{
    "name": "dir_out",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"没有采购流程，直接出库，比如内部生产的产品出库到其他工厂",

    "request": [
        {"name":"factory", "type":"int", "must":true, "min":0, "comment":"工厂ID，用于分库"},
        {"name":"sku", "type":"int", "must":true, "min":0, "comment":"sku ID"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"出库数量"},
        {"name":"no", "type":"string", "must":true, "min":1, "comment":"出库资产编号"},
        {"name":"cmt", "type":"string", "must":true, "min":0, "comment":"描述，比如位置等信息"}
    ],

    "process" : [
        {
            "name" : "get_sku_info",
            "type" : "rdb",
            "db" : "common",
            "comment" : "查询年折旧率，记入resource中，便于每月计算折旧，顺便确认SKU是否存在",
            "sqls" : [{
                "name" : "get_sku_info",
                "metas" : "each",
                "multi" : false,
                "merge" : true,
                "sql" : "select monthDepr,noHead,type,name from sku where id=@{sku}"
            }],
            "onSuccess":{
                "condition":"@{CONDITION|!type,'s.==','PART'}||@{CONDITION|num,'i.==',1}",
                "errorCode":"WRONG_PARAMETER",
                "errorInfo":"invalid parameter 'num'"
            }
        },
        {
            "name" : "update_inventory",
            "type" : "rdb",
            "db": "inventory",
            "sharding":"@{factory}",
            "sqls" : [
                {
                    "expected":{"num":1,"errorCode":"DATA_WRONG","errorInfo":"not enough"},
                    "sql":"update inventory set num=num-@{num} where no='@{no}' and num>@{num}"
                },
                "delete from inventory where no='@{no}' and num=0"
            ]
        },
        {
            "name" : "update_resource_state",
            "type" : "rdb",
            "db": "resource",
            "when":"@{CONDITION|!type,'s.!=','PART'}", //零件没记录resource
            "sharding" : "@{ABSHASH|no}",
            "sqls" : [
                "update resource set state='NONE' where no='@{no}'"
            ]
        }
    ],
    "response":[]
},
{
    "name": "setState",
    "method":"PUT",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"外部发货，当发货出现异常情况时，由发货执行人设置发货的状态",

    "request": [
        {"name":"factory", "type":"int", "must":true, "min":0, "comment":"工厂ID，用于分库"},
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"出库记录ID"},
        {"name":"at", "type":"int", "must":true, "min":0, "comment":"确认时间"},
        {"name":"state", "type":"string", "must":true, "options":["PART","LOST","BACK"], "comment":"发货状态"}
    ],

    "process" : [
        {
            "name" : "set_outbound_state",
            "type" : "rdb",
            "db": "log",
            "sharding":"@{NOW|yyyy}",
            "sqls" : [
                "update outbound set state='@{state}'
                   where id=@{id} and execAcc='@{#tokenAcc}'"
            ]
        }
    ]
}
]