[
{
    "name" : "set",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "设置绩效",

    "request": [
        {"name":"uid", "type":"int", "must":true, "min":1, "comment":"用户id"},
        {"name":"month", "type":"int", "must":true,  "comment":"月度，UTC月份"},
        {"name":"level", "type":"int", "must":true,  "comment":"等级，可以用于计算奖金"},
        {"name":"cmt", "type":"string", "must":false, "default":"", "comment":"备注"}
    ],
    
    "process" : [
        {"macro":"is_his_leader", "#UID#":"@{uid}"},
        {
            "name" : "set_perf",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                "insert into performance(uid,month,level,cmt)
                 values(@{uid},@{month},@{level},'@{cmt}')"
            ]
        }
    ]
},
{
    "name" : "setComment",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "设置绩效描述，一旦设置了，不可删除，不可修改等级",

    "request": [
        {"name":"uid", "type":"int", "must":true, "min":1, "comment":"用户id"},
        {"name":"month", "type":"int", "must":true,  "comment":"月度，UTC月份"},
        {"name":"cmt", "type":"string", "must":true, "comment":"备注"}
    ],

    "process" : [
        {"macro":"is_his_leader", "#UID#":"@{uid}"},
        {
            "name" : "set_perf",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                "update performance set cmt='@{cmt}'
                where uid=@{uid} and month=@{month}"
            ]
        }
    ]
},
{
    "name" : "list",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "查看部门中所有成员的绩效",

    "request": [
        {"name":"gid", "type":"int", "must":true,  "comment":"群组id"},
        {"name":"month", "type":"int", "must":true,  "comment":"月度，UTC月份"},
        {"name":"num", "type":"int", "must":true,  "comment":"数量"},
        {"name":"offset", "type":"int", "must":true,  "comment":"偏移"}
    ],
    
    "process" : [
        {"macro":"is_grp_leader", "#GID#":"@{gid}"},
        {
            "name" : "get_members",
            "type" : "rdb",
            "db":"hr",
            "sqls" : [
                {
                    "name" : "uids",
                    "metas":"oneCol",
                    "multi":true,
                    "sql":"select uid from member where gid=@{gid}
                        order by uid
                        LIMIT @{num} OFFSET @{offset}"
                },
                {
                    "name" : "total",
                    "metas":"each",
                    "multi":true,
                    "sql":"select count(*) total from member where gid=@{gid}"
                }
            ]
        },
        {
            "name" : "list_perf",
            "type" : "rdb",
            "db":"log",
            "sqls" : [{
                "name" : "list",
                "metas":"each",
                "multi":true,
                "sql":"select uid,month,level,cmt from performance
                    where uid in(@{LIST|!uids}) and month=@{month}"
            }]
        }
    ],
    "response":[
        {"name":"list", "type":"object", "must":true},
        {"name":"total", "type":"int", "must":true}
    ]
},
{
    "name" : "my",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "查询绩效",

    "request": [
        {"name":"start", "type":"int", "must":true,  "comment":"开始月度，UTC月份"},
        {"name":"end", "type":"int", "must":true,  "comment":"结束月度，UTC月份"}
    ],
    
    "process" : [
        {
            "name" : "get_perfs",
            "type" : "rdb",
            "db":"log",
            "sqls" : [{
                "name":"list",
                "metas":"each",
                "multi":true,
                "sql":"select month,level,cmt from performance
                    where uid=@{#tokenCaller}
                     and month>@{start} and month<=@{end}"
            }]
        }
    ]
}
]