[
{
    "name" : "set",
    "method" : "PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "设置绩效",

    "request": [
        {"name":"uid", "type":"int", "must":true, "min":1, "comment":"用户id"},
        {"name":"month", "type":"int", "must":true, "comment":"月度，UTC月份"},
        {"name":"level", "type":"string", "must":true, "regular":"[!-~]{1,4}", "comment":"等级，可以用于计算奖金"},
        {"name":"cmt", "type":"string", "must":false, "default":"", "comment":"备注"}
    ],

    "process" : [
        {"macro":"is_his_leader", "#UID#":"@{uid}"},
        {
            "name" : "set_perf",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                "update performance set level='@{level}',cmt='@{cmt}'
                 where uid=@{uid} and month=@{month} and cfmed='N'"
            ]
        }
    ],
    "response":[]
},
{
    "name" : "init",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "初始化绩效",

    "request": [
        {"name":"gid", "type":"int", "must":true, "min":0, "comment":"部门id"},
        {"name":"month", "type":"int", "must":true,  "comment":"月度，UTC月份"}
    ],
    
    "process" : [
        {"macro":"is_grp_leader", "#GID#":"@{gid}"},
        {
            "name" : "get_members",
            "type" : "rdb",
            "db":"hr",
            "sqls" : [{
                "name" : "uids",
                "metas":"none",
                "multi":true,
                "sql":"select uid from member where gid=@{gid}"
            }]
        },
        {
            "name" : "init_perf",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                "js: var uids=@{!uids};
                 var sql=['insert or ignore into performance(uid,month,level,cmt) values'];
                 for(var i in uids) {
                    if(i > 0 ) sql.push(',');
                    sql.push('(',uids[i],`,@{month},'','')`);
                 }
                 DB.sql(sql.join(''))"
            ]
        }
    ]
},
{
    "name" : "clear",
    "method" : "DELETE",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "清除绩效",

    "request": [
        {"name":"gid", "type":"int", "must":true, "min":0, "comment":"部门id"},
        {"name":"month", "type":"int", "must":true,  "comment":"月度，UTC月份"}
    ],
    
    "process" : [
        {"macro":"is_grp_leader", "#GID#":"@{gid}"},
        {
            "name" : "get_members",
            "type" : "rdb",
            "db":"hr",
            "sqls" : [{
                "name" : "uids",
                "metas":"oneCol",
                "multi":true,
                "sql":"select uid from member where gid=@{gid}"
            }]
        },
        {
            "name" : "clear_perf",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                "delete from performance where uid in(@{LIST|!uids}) and cfmed='N'"
            ]
        }
    ],
    "response":[]
},
{
    "name" : "confirm",
    "method" : "PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "确认一个部门的所有绩效，确认后就不可以修改",

    "request": [
        {"name":"gid", "type":"int", "must":true, "min":0, "comment":"部门id"},
        {"name":"month", "type":"int", "must":true,  "comment":"月度，UTC月份"}
    ],

    "process" : [
        {"macro":"is_grp_leader", "#GID#":"@{gid}"},
        {
            "name" : "get_members",
            "type" : "rdb",
            "db":"hr",
            "sqls" : [{
                "name" : "uids",
                "metas":"oneCol",
                "multi":true,
                "sql":"select uid from member where gid=@{gid}"
            }]
        },
        {
            "name" : "confirm_perfs",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                "update performance set cfmed='Y'
                where uid in(@{LIST|!uids}) and month=@{month} and cfmed='N'"
            ]
        }
    ]
},
{
    "name" : "list",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "查看部门中所有成员的绩效",

    "request": [
        {"name":"gid", "type":"int", "must":true,  "comment":"群组id"},
        {"name":"month", "type":"int", "must":true,  "comment":"月度，UTC月份"}
    ],
    
    "process" : [
        {"macro":"is_grp_leader", "#GID#":"@{gid}"},
        {
            "name" : "get_members",
            "type" : "rdb",
            "db":"hr",
            "sqls" : [{
                "name" : "uids",
                "metas":"oneCol",
                "multi":true,
                "sql":"select uid from member where gid=@{gid}"
            }]
        },
        {
            "name" : "list_perf",
            "type" : "rdb",
            "db":"log",
            "sqls" : [{
                "name" : "list",
                "metas":"each",
                "multi":true,
                "sql":"select uid,month,level,cfmed,cmt from performance
                    where uid in(@{LIST|!uids}) and month=@{month}"
            }]
        }
    ],
    "response":[
        {"name":"list", "type":"object", "list":true}
    ]
},
{
    "name" : "my",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "查询绩效",

    "request": [
        {"name":"offset", "type":"int", "must":true, "min":1, "comment":"偏移"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"数量"}
    ],
    
    "process" : [
        {
            "name" : "get_perfs",
            "type" : "rdb",
            "db":"log",
            "sqls" : [{
                "name":"list",
                "metas":"each",
                "multi":true,
                "sql":"select month,level,cmt,cfmed from performance
                    where uid=@{#tokenCaller}
                     order by month desc
                     LIMIT @{num} OFFSET @{offset}"
            }]
        }
    ]
}
]