[
{
    "name": "wait",
    "method": "GET",
    "property": "private",
    "tokenChecker": "USER",
    "aclChecker": "ABAC",
    "feature": "tasktime",
    "comment" : "等待项目经理确认的工时申报",
    
    "request": [
        {"name":"pid", "type":"int", "must":true, "min":0, "comment":"项目id"},
        {"name":"month", "type":"int", "must":true, "comment":"工时时间，UTC月数"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"查询数量"},
        {"name":"offset", "type":"int", "must":true, "min":1, "comment":"偏移"}        
    ],
    
    "aclProcess" : [
        {"macro":"is_prj_leader", "#PID#":"@{pid}"}
    ],    
    
    "process" : [
        {
            "name" : "get_tasktime",
            "type" : "rdb",
            "db" : "log",
            "sharding" : "@{NOW|`yyyy`}",
            "sqls" : [
                {
                    "name":"list",
                    "metas" : "each",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select t.uid,a.account,t.ratio,t.state,t.cmt
                     from tasktime t,applies a
                     where t.pid=@{pid} and t.month=@{month} and a.id=t.aid
                     order by t.update_time asc
                     LIMIT @{num} OFFSET @{offset}"
                },
                {
                    "name":"get_total",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "sql" : "select count(*) total from tasktime
                     where pid=@{pid} and month=@{month}"
                }
            ]
        }
    ]
},
{
    "name" : "getApply",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "查看工时申请详情",

    "request": [
        {"name":"id", "type":"int", "must":true, "comment":"申请id"}
    ],

    "process" : [
        {
            "name" : "get_apply_times",
            "type" : "rdb",
            "db" : "log",
            "sqls" : [
                {
                    "name" : "apply_info",
                    "metas" : "each",
                    "multi" : false,
                    "merge" : true,
                    "sql" : "select uid,account,type,state from applies where id=@{id}"
                },
                {
                    "name" : "items",
                    "multi" : true,
                    "merge" : false,
                    "metas" : "each",
                    "sql" : "select month,ratio,state,pid,prjName,cfmAcc,cmt from tasktime where aid=@{id}"
                }
            ]
        },
        //查看自己的申请，无需确认，否则需要是部门经理
        {"macro":"is_his_leader", "#UID#":"@{!uid}",
         "when":"@{CONDITION|!uid,'i.!=',#tokenCaller}"}
    ]
},

{
    "name" : "declare",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "工时申报",
    
    "request": [
        {"name":"id", "type":"int", "must":false, "comment":"申请id，不为空时，表示已生成applies记录"},
        {"name":"month", "type":"int", "must":true, "comment":"工时时间，UTC月数"},
        {"name":"list", "type":"object", "list":true, "must":true, "minSize":1, "props":[
            {"name":"pid", "type":"int", "must":true, "comment":"项目ID"},
            {"name":"prjName", "type":"string", "must":true, "comment":"项目名称，冗余字段，便于查询"},
            {"name":"ratio", "type":"int", "must":true, "comment":"分摊比率"},
            {"name":"cmt", "type":"string", "must":true, "comment":"描述"}
        ]}
    ],
    
    "process" : [
        {
            "name":"get_total_ratio",
            "type":"var",
            "vars":{
                "totalRatio":"@{SUM|i,list,'ratio'}"
            },
            "onSuccess":{
                "condition":"@{CONDITION|totalRatio,'i.==',100}",
                "errorCode":4100,
                "errorInfo":"sum of ratio is not 100"
            }
        },
        {
            "name" : "get_apply_id",
            "type" : "var",
            "when" : "@{CONDITION|id,'s.==',''}",
            "vars":{
                "id":"@{SEQUENCE|'applyid'}"
            }
        },
        {
            "name" : "get_department_id",
            "type" : "rdb",
            "db" : "hr",
            "sqls" : [{
                "name" : "department_id",
                "metas" : "each",
                "merge" : true,
                "multi" : false,
                "sql" : "select M.gid from member M,grp G
                     where M.uid=@{#tokenCaller} and M.role='NOR'
                      and G.id=M.gid and G.type='D'"
            }]
        },
        {
            "name" : "declare_tasktime",
            "type" : "rdb",
            "db" : "log",
            "sharding" : "@{NOW|`yyyy`}",
            "sqls" : [
                "replace into applies(id,uid,gid,account,type,state)
                 values(@{id},@{#tokenCaller},@{!gid},'@{#tokenAcc}','TASK','INIT')",

				"delete from tasktime where aid=@{id}",

				"insert into tasktime(aid,uid,month,pid,prjName,ratio,cmt) values
				@{FOR|list,`,`,`(@{id},@{#tokenCaller},@{month},`,
				  e.pid,`,'`,e.prjName,`',`,e.ratio,`,'`,e.cmt,`')`}"
		    ]
        }
    ],
    "response":[]
},
{
    "name" : "cancel",
    "method" : "DELETE",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "取消申请，只能申请人自己取消",
    
    "request": [
        {"name":"id", "type":"int", "must":true, "comment":"申请id"}
    ],
    
    "process" : [
        {
            "name" : "cancel",
            "type" : "rdb",
            "db" : "log",
            "sqls" : [
                {
                    "expected":{"num":1,"errorCode":"NO_RIGHT","errorInfo":"no right"},
                    "sql":"delete from applies
                         where id=@{id} and uid=@{#tokenCaller} and state<>'OK'"
                },
                "delete from tasktime where aid=@{id}"
            ]
        }
    ],
    "response":[]
},
{
    "name" : "confirm",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker": "ABAC",
    "feature": "tasktime",
    "comment" : "项目经理对工时申报进行确认或拒绝",

    "request": [
        {"name":"uid", "type":"int", "must":true, "comment":"申报人帐号id"},
        {"name":"pid", "type":"int", "must":true, "min":0, "comment":"项目ID"},
        {"name":"month", "type":"int", "must":true, "comment":"工时时间，UTC月数"},
        {"name":"state", "type":"string", "must":true, "options":["OK","REJ"]}
    ],
    
    "aclProcess" : [
        {"macro":"is_prj_leader", "#PID#":"@{pid}"}
    ],
    
    "process" : [{
        "name" : "cfm_tasktime",
        "type" : "rdb",
        "db" : "attendance",
        "sharding" : "@{NOW|`yyyy`}",
        "sqls" : [
            "update tasktime set cfmAcc='@{#tokenAcc}',state='@{state}'
              where uid=@{uid} and month=@{month} and pid=@{pid}"
        ]
    }]
},
{
    "name" : "commit",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "feature": "tasktime",
    "comment" : "部门经理对工时申报进行确认或拒绝，确认后会上报给ihr与iproject计算分摊",

    "request": [
        {"name":"aid", "type":"int", "must":true, "comment":"工时申报申请id"},
        {"name":"state", "type":"string", "must":true, "options":["OK","REJ"]},
        {"name":"opinion", "type":"string", "must":true, "comment":"审批意见"}
    ],

    "process" : [
        {
            "name" : "get_tasktime_info",
            "type" : "rdb",
            "db": "log",
            "sharding": "@{NOW|`yyyy`}",
            "sqls": [
                {
                    "name" : "get_uid_gid",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "sql":"select uid,gid from applies id=@{aid}"
                },
                {
                    "name" : "get_tasktime_ratio",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "sql":"select sum(ratio) totalRatio,month from tasktime
                     where aid=@{aid} and state='OK' group by month"
                }
            ],
            "onSuccess":{
                "condition":"@{CONDITION|state,'i.==','REJ'}
                    || @{CONDITION|!totalRatio,'i.==',100}",
                "errorCode":4100,
                "errorInfo":"sum of ratio is not 100"
            }
        },
        {"macro":"is_grp_leader", "#GID#":"@{!gid}"},
        {
            "name" : "get_timeoff",
            "type" : "rdb",
            "db":"hr",
            "when" : "@{CONDITION|state,'s.==','OK'}",
            "sqls" : [{
                "name" : "timeoff",
                "metas" : "each",
                "merge" : true,
                "multi" : false,
                "sql" : "select Z.timeOff from employee E,office O,zone Z
                     where E.uid=@{!uid} and O.id=E.office and Z.id=o.zone"
            }]
        },
        {
            "name" : "get_start_end",
            "type" : "var",
            "vars":{
                "startMs":"@{UTC|!month,!timeOff,monthstart,month}",
                "endMs":"@{UTC|!month,!timeOff,monthend,month}",
                "start":"@{UTC|startMs,0,unit60000}",
                "end":"@{UTC|endMs,0,unit60000}"
            }
        },
        {
            "name" : "get_total_resrouce",
            "type" : "rdb",
            "when" : "@{CONDITION|state,'s.==','OK'}",
            "db":"hr",
            "sqls" : [{
                "name" : "resource",
                "metas" : "each",
                "merge" : true,
                "multi" : false,
                "sql" : "select ifnull(sum(monthDepr),0) resource
                    from resource where uid=@{!uid}"
            }]
        },
        {
            "name" : "get_tasktime",
            "type" : "rdb",
            "when" : "@{CONDITION|state,'s.==','OK'}",
            "db" : "attendance",
            "sharding" : "@{NOW|`yyyy`}",
            "convert":{"code":"NOT_EXISTS", "to":6107, "info":"no attendance record"},
            "sqls" : [{
                "name" : "total_tasktime",
                "metas" : "each",
                "merge" : true,
                "multi" : false,
                "sql" : "select ifnull(sum(end-start),0) tasktime from attendance
                     where uid=@{!uid} and type in('WORK','WOW','FOW','OOW')
                       and start>@{start} and start<@{end}"
            }]
        },
        {
            "name" : "get_tasktime",
            "type" : "rdb",
            "when" : "@{CONDITION|state,'s.==','OK'}",
            "db" : "attendance",
            "sharding" : "@{NOW|`yyyy`}",
            "convert":{"code":"NOT_EXISTS", "to":6107, "info":"no tasktime record"},
            "sqls" : [
                {
                    "name" : "reports",
                    "metas" : "each",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select pid,uid,month,
                        ratio*@{!tasktime} workload,
                        ratio*@{!resource} resource,
                        ratio
                       from tasktime
                     where aid=@{aid} and uid=@{!uid}"
                }
            ]
        },
        {
            "name" : "set_to_finance", //向财务汇报项目工时、资源折旧成本与分摊比率
            "when" : "@{CONDITION|state,'s.==','OK'}",
            "type" : "call",
            "service" : "ifinance",
            "method" : "PUT",
            "tokenSign" : "APP",
            "url" : "/project/share",
            "parameters":"{\"list\":@{LIST|!reports}}"
        },
        {
            "name" : "set_apply_state",
            "type" : "rdb",
            "db" : "log",
            "sharding" : "@{NOW|`yyyy`}",
            "sqls" : [
                "update applies set
                     cfmAcc='@{#tokenAcc}',
                     state='@{state}',
                     opinion='@{opinion}'
                  where id=@{aid}"
            ]
        }
    ],
    
    "response":[]
}
]