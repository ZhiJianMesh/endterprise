[
{
    "name" : "listbypid",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "查询某个项目的所有出差记录",

    "request": [
        {"name":"pid", "type":"int", "must":true, "min":0, "comment":"项目ID"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"查询数量"},
        {"name":"offset", "type":"int", "must":true, "min":1, "comment":"偏移"}
    ],
    
    "process" : [
        {
            "name" : "list_business",
            "type":"rdb",
            "db":"log",
            "sqls" : [
                {
                    "name":"list",
                    "metas" : "cols",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select b.pid,b.start,b.end,b.dest,b.account,b.cmt,p.name pName
                     from business b, project p where b.pid=@{pid}
                      and p.id=@{pid} and p.leader='@{#tokenAcc}'
                     order by start desc
                     LIMIT @{num} OFFSET @{offset}"
                },
                {
                    "name":"get_total",
                    "metas" : "each",
                    "merge":true,
                    "multi":false,
                    "sql":"select count(*) total from business where pid=@{pid}"
                }
            ]
        }
    ]
},

{
    "name" : "my",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "查询自己的所有出差记录",

    "request": [
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"查询数量"},
        {"name":"offset", "type":"int", "must":true, "min":1, "comment":"偏移"}
    ],
    
    "process" : [
        {
            "name" : "list_business",
            "type":"rdb",
            "db":"log",
            "sqls" : [
                {
                    "name":"list",
                    "metas" : "cols",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select b.pid,b.start,b.end,b.dest,b.account,b.cmt,p.name pName
                      from business b,project p
                      where b.account='@{#tokenAcc}' and p.id=b.pid
                     order by start desc
                     LIMIT @{num} OFFSET @{offset}"
                },
                {
                    "name":"get_total",
                    "metas" : "each",
                    "merge":true,
                    "multi":false,
                    "sql":"select count(*) total from business
                         where account='@{#tokenAcc}'"
                }
            ]
        }    
    ]
},

{
    "name" : "detail",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker" : "RBAC",
    "feature" : "hr",
    "comment" : "查询出差详情",

    "request": [
        {"name":"pid", "type":"int", "must":true, "min":0, "comment":"项目ID"},
        {"name":"start", "type":"int", "must":true, "comment":"开始时间"},
        {"name":"account", "type":"string", "must":true, "min":1, "comment":"出差员工帐号"}
    ],
    
    "process" : [
        {
            "name" : "get_business",
            "type":"rdb",
            "db":"log",
            "sqls" : [
                {
                    "name":"detail",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "sql" : "select b.start,b.end,b.subsidy,b.expense,b.state,
                        b.account,b.cfmAcc,b.dest,b.cmt,p.name pName
                        from business b,project p
                        where b.pid=@{pid} and b.start=@{start}
                         and b.account='@{account}' and p.id=b.pid"
                }
            ]
        }    
    ]
},

{
    "name" : "create",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "创建出差记录",

    "request": [
        {"name":"pid", "type":"int", "must":true, "min":0, "comment":"项目ID"},
        {"name":"start", "type":"int", "must":true,"comment":"开始日期，UTC分钟"},
        {"name":"end", "type":"int", "must":true, "comment":"结束日期，UTC分钟"},
        {"name":"dest", "type":"string", "must":true, "min":1, "max":80, "comment":"出差目的端"},
        {"name":"cmt", "type":"string", "must":true, "min":0, "max":300, "comment":"附加信息"}
    ],
    
    "vars" : [
        {"name":"id", "response":"true", "val":"@{SEQUENCE|i,businessid}", "comment":"项目id"}
    ],

    "process" : [
        {
            //获得帐号对应的时区偏移
            "name" : "get_employee",
            "type" : "call",
            "method" : "GET",
            "service" : "hr",
            "url" : "/employee/baseinfo?uid=@{#tokenCaller}",
            "tokenSign" : "APP",
            "trans" : false
        },  
        {
            "name" : "create_business",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                "insert into business(id,pid,start,end,timeDiff,account,dest,cmt) values
                (@{id},@{pid},@{start},@{end},@{!timeDiff},'@{#tokenAcc}','@{dest}','@{cmt}')"
            ]
        }
    ]
},

{
    "name" : "update",
    "method" : "PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "修改出差信息",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"出差ID"},
        {"name":"pid", "type":"int", "must":true, "comment":"项目ID"},
        {"name":"start", "type":"int", "must":true, "comment":"开始日期，UTC分钟"},
        {"name":"end", "type":"int", "must":true, "comment":"结束日期，UTC分钟"},
        {"name":"subsidy", "type":"float", "must":true, "comment":"补贴，按天计算"},        
        {"name":"dest", "type":"string", "must":true, "min":1, "max":80, "comment":"出差目的端"},
        {"name":"cmt", "type":"string", "must":true, "min":0, "max":500, "comment":"附加信息"}
    ],

    "process" : [
        {
            "name" : "update_business",
            "type" : "rdb",
            "db":"log",
            "sqls" : [{
                "affectNone":111,
                "sql":"update business set
                    pid=@{pid},
                    start=@{start},
                    end=@{end},
                    subsidy=@{subsidy},
                    dest='@{dest}',
                    cmt='@{cmt}'
                where id=@{id}
                  and account='@{#tokenAcc}'
                  and state='RUN'"
            }]
        }
    ]
},

{
    "name" : "remove",
    "method" : "DELETE",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "删除出差信息",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"出差ID"}
    ],
    
    "process" : [
        {
            "name" : "rmv_business",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                {
                    "affectNone":111,
                    "sql":"delete from business where id=@{id}
                     and account='@{#tokenAcc}' and state='RUN'"
                },
                "delete from expense where type='BUSI' and did=@{id}"
            ]
        }
    ]
},

{
    "name" : "commit",
    "method" : "PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "提交给项目经理审核",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"出差ID"}
    ],
    
    "process" : [
        {
            "name" : "commit",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                "update business set
                   state='WAIT',
                   expense=(select sum(val) from expense where business=@{id})
                 where id=@{id} and state='RUN'
                   and account='@{#tokenAcc}'"
            ]
        }
    ]
},

{
    "name" : "confirm",
    "method" : "PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "项目经理确认报销",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"出差ID"}
    ],
    
    "process" : [
         {
            "name" : "confirm",
            "type" : "rdb",
            "db" : "log",
            "convert" : {"code":2001, "to":111, "info":"no rights"},
            "sqls" : [
                {
                    "name" : "expense",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "comment" : "如果不是项目经理，返回不存在",
                    "sql" : "select p.id pid,b.uid,b.subsidy,b.expense,b.timdOff
                     from project p,business b
                     where b.id=@{id} and p.id=b.pid and p.leader='@{#tokenAcc}'"
                },
                "update business set
                   state='OVER',
                   cfmAcc='@{#tokenAcc}',
                   cfmAt=@{NOW|unit60000}
                 where id=@{id} and state='WAIT'"
            ]
        },
        {
            "name" : "report_cost_to_other_services",
            "type" : "call",
            "method" : "POST",
            "url" : "/businessCost",
            "tokenSign" : "APP",
            "trans" : false,
            "parameters":"{
                \"pid\":@{pid},\"uid\":@{uid},\"subsidy\":@{!subsidy},
                \"expense\":@{!expense},\"month\":@{UTC|#reqAt,!timeOff,months}
            }",
            "calls": [ //每个服务接受business的接口都是一样的，所以参数都可以作为公共参数
                {"service":"hr"},
                {"service":"finance"}
            ]
        }
    ],
    "response":[]
},
{
    "name" : "reject",
    "method" : "PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "项目经理拒绝报销",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"出差ID"}
    ],
    
    "process" : [
        {
            "name" : "confirm",
            "type" : "rdb",
            "db" : "log",
            "convert" : {"code":2001, "to":111, "info":"no right"},
            "sqls" : [
                {
                    "name" : "expense",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "comment" : "如果不是项目经理，返回不存在",
                    "sql" : "select p.id pid from project p,business b
                     where b.id=@{id} and p.id=b.pid and p.leader='@{#tokenAcc}'"
                },
                "update business set
                   state='RUN',
                   cfmAcc='',
                   cfmAt=0
                 where id=@{id} and state='WAIT'"
            ]
        }
    ],
    "response":[]
}
]