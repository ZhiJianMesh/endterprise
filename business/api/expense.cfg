[
{
    "name" : "add",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "创建出差报销记录",

    "request": [
        {"name":"business", "type":"int", "must":true, "min":0, "comment":"出差ID"},
        {"name":"start", "type":"int", "must":true,"comment":"开始日期，UTC分钟"},
        {"name":"end", "type":"int", "must":true, "comment":"结束日期，UTC分钟"},
        {"name":"val", "type":"float", "must":true, "min":0, "comment":"报销金额"},
        {"name":"cmt", "type":"string", "must":true, "min":0, "max":300, "comment":"附加信息"}
    ],

    "process" : [
        {
            "name":"gen_expense_id",
            "type":"var",
            "toResp":true,
            "vars":{
                "id":"@{SEQUENCE|i,expenseid}"
            }
        },
        {
            "name" : "add_expense",
            "type" : "rdb",
            "db":"log",
            "sqls" : [{
                "affectNone":111,
                "sql":"insert into expense(id,business,start,end,val,cmt)
                 select @{id},id,@{start},@{end},@{val},'@{cmt}'
                  from business
                 where id=@{business} and account='@{#tokenAcc}' and state='RUN'"
            }]
        }
    ]
},

{
    "name" : "update",
    "method" : "PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "使用报销id，修改报销信息",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"费用报销ID"},
        {"name":"start", "type":"int", "must":true,"comment":"开始日期，UTC分钟"},
        {"name":"end", "type":"int", "must":true, "comment":"结束日期，UTC分钟"},
        {"name":"val", "type":"float", "must":true, "min":0, "comment":"报销金额"},
        {"name":"cmt", "type":"string", "must":true, "min":0, "max":300, "comment":"附加信息"}
    ],

    "process" : [
        {
            "name" : "update_expense",
            "type" : "rdb",
            "db":"log",
            "convert" : {"code":2001,"to":111,"info":"no right"},
            "sqls" : [
                {
                    "name":"get_business_info",
                    "metas":"each",
                    "merge":true,
                    "multi":false, //只是用来鉴权
                    "sql":"select e.did from expense e,business b
                      where e.id=@{id} and b.id=e.did
                       and b.account='@{#tokenAcc}' and b.state='RUN'"
                },
                "update expense set
                    start=@{start},
                    end=@{end},
                    val=@{val},
                    cmt='@{cmt}'
                 where id=@{id}"
            ]
        }
    ]
},

{
    "name" : "remove",
    "method" : "DELETE",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "删除报销信息项",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"费用报销ID"}
    ],
    
    "process" : [
        {
            "name" : "rmv_business",
            "type" : "rdb",
            "db" : "log",
            "convert" : {"code":2001,"to":111,"info":"no right"},
            "sqls" : [
                {
                    "name":"get_business_info",
                    "metas":"each",
                    "merge":true,
                    "multi":false,//只是用来鉴权
                    "sql":"select e.business from expense e,business b
                      where e.id=@{id} and b.id=e.business
                       and b.account='@{#tokenAcc}' and b.state='RUN'"
                },            
                "delete from expense where id=@{id}"
            ]
        }
    ]
}
]