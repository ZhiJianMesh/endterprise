[
{
    "name" : "report",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "comment" : "项目盈亏报表",

    "vars": [
        {"name":"pid", "type":"int", "must":true, "min":1, "comment":"项目ID"},
        {"name":"start", "type":"int", "must":true, "comment":"开始时间，UTC月数"},
        {"name":"end", "type":"int", "must":true, "comment":"结束时间，UTC月数"}
    ],

    "process" : [
        {
            "name":"judge_prj_right",
            "db":"log",
            "type":"rdb",
            "convert" : {"code":2001,"to":111,"info":"no right"},
            "sqls":[{
                "name":"chk_party",
                "metas":"each",
                "merge":true,
                "multi":false,
                "sql":"select name from project
                 where id=@{pid} and (leader='@{#tokenAcc}' or owner='@{#tokenAcc}')"
            }]
        },
        {
            "name" : "get_snapshot",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                {
                    "name" : "snapshot",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "sql" : "select 
                         sum(workload) workload,sum(salary) salary,
                         sum(subsidy) subsidy,sum(expense) expense,
                         sum(expense) expense,sum(resource) resource,
                         sum(receivable) receivable,sum(income) income,
                         sum(payable) payable,sum(pay) pay
                         from prjreport where pid=@{pid}
                          and month>@{start}-1 and month<@{end}+1"
                },
                {
                    "name" : "list",
                    "metas" : "each",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select month,workload,salary,subsidy,expense,
                         expense,resource,receivable,income,payable,pay
                         from prjreport
                     where pid=@{pid} and month>@{start}-1 and month<@{end}+1
                     group by month asc"
                }
            ]
        }
    ]
},
{
    "name": "set",
    "method":"PUT",
    "property" : "private",
    "tokenChecker" : "APP-hr,storage",
    "comment":"设置报表数据，由其他服务调用",

    "request": [
        {"name":"month", "type":"int", "must":true, "comment":"月份，1970年到现在的月份数"},
        {"name":"list", "type":"object", "must":true, "list":true, "min":1, "props":[
            {"name":"pid", "type":"int",  "must":true, "min":0, "comment":"项目ID"},
            {"name":"seg", "type":"string", "must":true,
             "options":["workload","salary","resource","receivable","income","payable","income"],
             "comment":"字段名，传字段名的方式不好，这里做了限制，同时为了方便，也就这么干了"},
            {"name":"val", "type":"double", "must":true, "comment":"字段值"}
        ], "comment":"报告列表"}
    ],

    "process" : [{
        "name" : "set_report_data",
        "type" : "rdb",
        "db": "project",
        "sqls" : [
            "js:var list=@{list}; var i=0;
            var sqls=['insert or ignore into prjreport(pid,month) values'];
            for(var l of list) {
                if(i>0) sqls.push(',');
                sqls.push('(', l.pid, ',@{month})');
                i++;
            }
            sqls.join('');
            ",

            "js:var list=@{list}; var sqls=[];
            for(var l of list) {
                sqls.push('update prjreport set @{seg}=@{seg}+', l.val,
                   ' where pid=', l.pid, ' and month=@{month}');
            }
            sqls.join('');
            "
        ]
    }]
}
]