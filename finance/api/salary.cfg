[
{
    "name" : "apply",
    "method" : "POST",
    "property" : "private",
    "tokenChecker" : "APP-hr",
    "comment" : "申请付薪，如果已经出现了，则在原有基础上加减",
    
    "request": [
        {"name":"uid", "type":"int", "must":true, "comment":"开始生效时间，UTC分钟"},
        {"name":"month", "type":"int", "must":true, "comment":"从1970.1至今的月份数"},
        {"name":"account", "type":"string", "must":true, "comment":"帐号，冗余字段"},
        {"name":"list", "type":"object", "list":true, "must":true, "props":[
            {"name":"type", "type":"string", "must":true,"comment":"类型",
             "options":["SALARY","SUBSIDY","EXPENSE","TAX","BONUS","SHARE","SECURITY"]},
            {"name":"val", "type":"double", "must":true, "comment":"金额"}
        ]},
        {"name":"cmt", "type":"string", "must":false, "default":"", "comment":"描述"}
    ],

    "process" : [
        {
            "name" : "add_salary_apply",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                "js:var sqls=['insert into salary(uid,month,type,val,applyAt,account,cmt) values'];
                 var list=@{list};
                 var i=0;
                 for(var l of list) {
                    if(i>0)sqls.push(',');
                    sqls.push(`@{uid},@{month},'`, l.type, `',`, l.val,
                        `,@{NOW|unit60000},'@{account}','@{cmt}'`);
                 }
                 DB.sql(sqls.join(''));
                 "
            ]
        },
        {
            "name" : "add_salary_balance",
            "type" : "rdb",
            "db":"finance",
            "sqls" : [
                "js:var val=0;
                 for(var l of list) {
                    val+=l.val;
                 }
                 DB.sql('update balance set val=val+' + val
                    +` where type='CDEBT_SALARY'`);
                "
            ]
        }
    ]
},
{
    "name" : "confirm",
    "method" : "PUT",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker" : "RBAC",
    "feature":"admin",
    "comment" : "确认付薪申请，在支付过后调用",
    
    "request": [
        {"name":"uid", "type":"int", "must":true, "comment":"开始生效时间，UTC分钟"},
        {"name":"month", "type":"int", "must":true, "comment":"从1970.1至今的月份数"},
        {"name":"type", "type":"string", "must":true,"comment":"类型",
         "options":["SALARY","SUBSIDY","EXPENSE","BONUS","SHARE","SECURITY"]},
        {"name":"tax", "type":"double", "must":false, "default":0, "comment":"应缴所得税"},
        {"name":"mode", "type":"string", "must":true, "options":["BANK","CASH","WX","ALIP"], "comment":"支付方式"}
    ],

    "process" : [
        {
            "name" : "cofirm_salary_apply",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                {
                    "affectNone":111,
                    "sql":"update salary set
                        payAt=@{NOW|unit60000},
                        cfmAcc='@{#tokenAcc}',
                        state='OK',
                        tax=@{tax},
                        mode='@{mode}'
                    where uid=@{uid} and month=@{month} and type='@{type}'
                     and state='WAIT' and payAt<=0"
                },
                {
                    "name" : "salary_val",
                    "metas" : "each",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select val from salary
                         where uid=@{uid} and month=@{month}"
                }
            ]
        },
        {
            "name" : "update_balance",
            "type" : "rdb",
            "db" : "finance",
            "comment" : "从公司现金中扣除工资，并减少待付工资",
            "sqls" : [
                "update balance set val=val-@{!val} where type='CUR_CASH'",
                "update balance set val=val-@{!val} where type='CDEBT_SALARY'"
            ]
        }
    ],
    "response":[]
},
{
    "name" : "wait",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker" : "RBAC",
    "feature":"admin",
    "comment" : "查询待付薪申请",

    "request": [
        {"name":"month", "type":"int", "must":true, "comment":"从1970.1至今的月份数"}
    ],
 
    "process" : [
        {
            "name" : "list_salaries",
            "type" : "rdb",
            "db" : "log",
            "sqls" : [
                {
                    "name" : "list",
                    "metas" : "each",
                    "merge" : false,
                    "multi" : true,
                    "sql" : "select uid,month,type,applyAt,val,tax,account,cmt
                     from salary where month=@{month} and state='WAIT'"
                }
            ]
        }
    ]
},
{
    "name" : "get",
    "method" : "GET",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker" : "RBAC",
    "feature":"admin",
    "comment" : "查询某个员工的付薪申请",
    
    "request": [
        {"name":"uid", "type":"int", "must":true, "comment":"开始生效时间，UTC分钟"},
        {"name":"month", "type":"int", "must":true, "comment":"从1970.1至今的月份数"},
        {"name":"type", "type":"string", "must":true,"comment":"类型",
         "options":["SALARY","SUBSIDY","EXPENSE","BONUS","SHARE","SECURITY"]}
    ],
            
    "process" : [
        {
            "name" : "get_salary",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                {
                    "name" : "salary",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "sql" : "select month,val,state,mode,applyAt,payAt,
                        val,account,cfmAcc,cmt from salary
                     where uid=@{uid} and month=@{month} and type='@{type}'"
                }
            ]
        },
        {
            "name" : "get_bank_account",
            "type" : "rdb",
            "db":"finance",
            "sqls" : [
                {
                    "name" : "account",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "sql" : "select bank,account bankAcc,name
                         from bankacc where id=@{uid} and type='EMPL'"
                }
            ]
        }
    ]
},
{
    "name" : "remove",
    "method" : "DELETE",
    "property" : "private",
    "tokenChecker" : "APP-hr",
    "comment" : "删除付薪记录，未确认支付的才可以删除",
    
    "request": [
        {"name":"uid", "type":"int", "must":true, "comment":"开始生效时间，UTC分钟"},
        {"name":"month", "type":"int", "must":true, "comment":"从1970.1至今的月份数"},
        {"name":"type", "type":"string", "must":true,"comment":"类型",
         "options":["SALARY","SUBSIDY","EXPENSE","BONUS","SHARE","SECURITY"]}
    ],

    "process" : [
        {
            "name" : "rmv_balance_item",
            "type" : "rdb",
            "db":"log",
            "sqls" : [
                {
                    "name" : "salary_val",
                    "metas" : "each",
                    "merge" : true,
                    "multi" : false,
                    "sql" : "select val from salary
                         where uid=@{uid} and month=@{month}
                           and type='@{type}' and state<>'OK'"
                },
                "delete from salary
                 where uid=@{uid} and month=@{month} and type='@{type}'
                   and state='WAIT' and payAt==0"
            ]
        },
        {
            "name" : "rmv_salary_balance",
            "type" : "rdb",
            "db":"finance",
            "sqls" : [
                "update balance set val=val-@{!val} where type='CDEBT_SALARY'"
            ]
        }
    ]
}
]