[
{
    "name": "listBySku",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"查询指定sku、指定状态的资源列表",

    "request": [
        {"name":"sku", "type":"int", "must":true, "min":0, "comment":"sku ID"},
        {"name":"offset", "type":"int", "must":true, "min":0, "comment":"偏移"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"返回行数"}
    ],

    "process" : [
        {
            "name" : "list_resources",
            "type" : "rdb",
            "db": "log",
            "sqls" : [{
                "name" : "list",
                "metas" : "each",
                "multi" : true,
                "merge" : false,
                "sql":"select no,createAt,num,price,sku,warehouse
                     from inventory where sku=@{sku}
                     order by no desc
                     LIMIT @{num} OFFSET @{offset}"
            }]
        }
    ]
},
{
    "name": "listByWh",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "comment":"按仓库查询的资产",

    "request": [
        {"name":"warehouse", "type":"int", "must":true, "min":0, "comment":"仓库id"},
        {"name":"checkAt", "type":"int", "must":false, "min":0, "comment":"清点日期"},
        {"name":"offset", "type":"int", "must":true, "min":0, "comment":"偏移"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"返回行数"}
    ],

    "process" : [
        {
            "name" : "list_resource",
            "type" : "rdb",
            "db": "common",
            "sqls" : [
                {
                    "name" : "list",
                    "metas" : "each",
                    "multi" : true,
                    "merge" : false,
                    "sql":"select no,createAt,num,price,sku,checkAt from inventory
                         where warehouse=@{warehouse} @{IFVALID|checkAt, 'and checkAt>', checkAt}
                         order by no desc
                         LIMIT @{num} OFFSET @{offset}"
                },
                {
                    "name" : "skuids",
                    "metas" : "onCol",
                    "multi" : true,
                    "merge" : false,
                    "sql":"select DISTINCT sku from inventory
                         where warehouse=@{warehouse} @{IFVALID|checkAt, 'and checkAt>', checkAt}
                         order by no desc
                         LIMIT @{num} OFFSET @{offset}"
                }
            ]
        },
        {
            "name" : "list_sku",
            "type" : "rdb",
            "db": "common",
            "sqls" : [
                {
                    "name" : "skus",
                    "metas" : "each",
                    "multi" : true,
                    "merge" : false,
                    "sql":"select S.id,S.type,S.name,S.speci,S.supplier,SU.name spName
                         from sku S,supplier SU
                         where S.id in@{@{LIST|skuids}} and SU.id=S.supplier"
                }
            ]
        }
    ]
},

{
    "name": "get",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "comment":"查询指定资源的信息",

    "request": [
        {"name":"no", "type":"string", "must":true, "min":0, "comment":"资产编号"}
    ],

    "process" : [
        {
            "name" : "get_resource",
            "type" : "rdb",
            "db": "log",
            "sqls" : [{
                "name" : "list",
                "metas" : "each",
                "multi" : false,
                "merge" : true,
                "sql":"select createAt,num,price,sku,tranNo,checkAt
                     from inventory where no='@{no}'"
            }]
        },
        {
            "name" : "get_sku",
            "type" : "rdb",
            "db": "common",
            "sqls" : [{
                "name" : "sku_info",
                "metas" : "each",
                "multi" : false,
                "merge" : true,
                "sql":"select S.type,S.name,S.speci,S.cmt,
                     s.supplier,SP.name spName
                   from sku S,supplier SP
                 where S.id=@{!sku} and SP.id=S.supplier"
            }]
        }
    ]
},
{
    "name": "discard",
    "method":"POST",
    "property" : "private",
    "tokenChecker" : "USER",
    "aclChecker" : "RBAC",
    "feature" : "whadmin"
    "comment":"资源报废，资产挂账人先通过入库申请，将资产退回仓库，再由仓库管理员报废",

    "request": [
        {"name":"no", "type":"string", "must":true, "min":1, "comment":"资产编号"},
        {"name":"warehouse", "type":"int", "must":true, "min":0, "comment":"仓库ID"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"数量"}
    ],

    "process" : [
        {
            "name" : "decrease_inventory_num",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                {
                    "expected":{"num":1,"code":2001,"info":"not exists"},
                    "sql":"update inventory set num=num-@{num}
                        where no='@{no}' and num>=@{num}"
                },
                "insert into discard(no,warehouse,num,at,cfmAcc)
                values('@{no}',@{warehouse},@{num},@{NOW|60000},'@{#tokenAcc}')"
            ]
        },
        {
            "name" : "decrease_resource_num",
            "type" : "rdb",
            "db": "resource",
            "sqls" : [ //不确认num是否足够，以inventory中num为准
                "update resource set num=num-@{num} where no='@{no}'"
            ]
        }
    ]
}
]