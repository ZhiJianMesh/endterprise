[
{
    "name": "resources",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"查询指定sku、指定状态的资源列表",

    "request": [
        {"name":"sku", "type":"int", "must":true, "min":0, "comment":"sku ID"},
        {"name":"state", "type":"string", "must":true,
         "options":["IDLE","USE","DISC","USED","LOST"], "comment":"状态"},
        {"name":"offset", "type":"int", "must":true, "min":0, "comment":"偏移"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"返回行数"},
        {"name":"cmt", "type":"string", "must":true, "comment":"描述"}
    ],

    "process" : [
        {
            "name" : "list_resources",
            "type" : "rdb",
            "db": "resource",
            "sqls" : [{
                "name" : "list",
                "metas" : "each",
                "multi" : true,
                "merge" : false,
                "sql":"select id,createAt,num,no,val
                     from resource where sku=@{sku} and state='@{state}'
                     order by id desc
                     LIMIT @{num} OFFSET @{offset}"
            }]
        }
    ]
},

{
    "name": "inbound",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"资源入库",

    "request": [
        {"name":"warehouse", "type":"int", "must":true, "min":0, "comment":"仓库ID"},
        {"name":"sku", "type":"int", "must":true, "min":0, "comment":"sku ID"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"数量"},
        {"name":"val", "type":"double", "must":true, "min":0, "comment":"初始价值"},
        {"name":"outDate", "type":"int", "must":true, "min":1, "comment":"供应商发货时间"},
        {"name":"type", "type":"string",  "must":true, "options":["INN","EXT"], "comment":"类型"},
        {"name":"tranNo", "type":"string", "must":true, "min":1, "comment":"外部或内部运单号"},
        {"name":"cfmAcc", "type":"string", "must":true, "min":1, "comment":"入库确认人"},
        {"name":"cmt", "type":"string", "must":true, "min":1, "comment":"备注"}
    ],

    "process" : [
        {
            "name" : "get_sku_info",
            "type" : "rdb",
            "db" : "common",
            "comment" : "查询年折旧率，记入resource中，便于每年计算折旧，顺便确认SKU是否存在",
            "sqls" : [{
                "name" : "get_sku_info",
                "metas" : "each",
                "multi" : false,
                "merge" : true,
                "sql" : "select deprRate,noHead from sku where id=@{sku}"
            }]
        },
        {
            "name" : "get_res_no",
            "type" : "var",
            "toResp" : true,
            "vars":{
                "no":"@{!noHead}@{NOW|yyyyMMddHHmmssSSS}"
            }
        },
        {
            "name" : "save_resource",
            "type" : "rdb",
            "db": "resource",
            "sqls" : [
                "insert into resource(createAt,num,no,val,deprRate)
                 values(@{NOW|unit60000},@{num},'@{no}',@{val},@{!deprRate})"
            ]
        },
        {
            "name" : "log_inbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                "insert into inbound(warehouse,no,tranNo,outDate,inDate,type,sku,num,cfmAcc,cmt)
                 values(@{warehouse},'@{no}','@{tranNo}',@{outDate},@{NOW|unit60000},'@{type}',
                 @{sku},@{num},'@{#tokenAcc}','@{cmt}')"
            ]
        },
        {
            "name" : "save_inventory",
            "type" : "rdb",
            "db": "common",
            "comment":"在仓库现有资源清单中添加记录",
            "sqls" : [
                "insert into inventory(warehouse,tranNo,sku,num,no,cmt)
                 values(@{warehouse},'@{tranNo}',@{sku},@{num},'@{no}','@{cmt}')"
            ]
        }
    ]
},

{
    "name": "applyoutbound",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "comment":"资源出库申请",

    "request": [
        {"name":"warehouse", "type":"int", "must":true, "min":0, "comment":"仓库ID"},
        {"name":"pid", "type":"int", "must":true, "min":0, "comment":"项目ID"},
        {"name":"sku", "type":"int", "must":true, "min":0, "comment":"SKU ID"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"数量"},
        {"name":"expDate", "type":"int", "must":true, "min":1, "comment":"供应商发货时间"},
        {"name":"type", "type":"string", "must":true, "options":["INN","EXT"], "comment":"发货类型"},
        {"name":"receiver", "type":"string", "must":true, "min":1, "comment":"收件人，包括姓名、地址、电话"},
        {"name":"cmt", "type":"string", "must":true, "min":1, "comment":"备注"}
    ],

    "vars":[
        {"name":"id", "type":"string", "val":"@{SEQUENCE|i,outboundid}", "response":true, "comment":"出库id"}
    ],

    "process" : [
        {
            "name" : "save_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                "insert into outbound(id,pid,warehouse,type,expDate,
                    sku,num,applicant,receiver,applyCmt)
                 values(@{id},@{pid},@{warehouse},'@{type}',@{expDate},
                    @{sku},@{num},'@{#tokenAcc}','@{receiver}','@{cmt}')"
            ]
        }
    ]
},

{
    "name": "outbound",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "comment":"执行资源出库",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"出库记录ID"},
        {"name":"no", "type":"string", "must":true, "min":1, "comment":"出库资产编号"},
        {"name":"tranNo", "type":"string", "must":true, "min":1, "comment":"运单号"},
        {"name":"cmt", "type":"string", "must":false, "min":1, "comment":"备注"}
    ],

    "process" : [
        {
            "name" : "get_outbound_info",
            "type" : "rdb",
            "db": "log",
            "sqls" : [{
                "name" : "get_sku",
                "metas" : "each",
                "multi" : false,
                "merge" : true,
                "sql" : "select sku,num from outbound where id=@{id}"
            }]
        },    
        {
            "name" : "rmv_inventory",
            "type" : "rdb",
            "db": "common",
            "convert" : {"code":2001,"to":3003,"info":"no enough inventory"},
            "sqls" : [
                {
                    "expected" : {"num":1, "code":2001, "info":"inventory not enough"},
                    "sql":"update inventory set num=num-@{!num} where no='@{no}' and num>=@{!num}"
                },
                "delete from inventory where no='@{no}' and num<=0"
            ]
        },
        {
            "name" : "update_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                "update outbound set
                    tranNo='@{tranNo}',
                    no='@{no}',
                    cmt='@{cmt}',
                    execAcc='@{#tokenAcc}',
                    outDate=@{NOW|unit60000}
                 where id=@{id}"
            ]
        },
        
        {
            "name" : "update_resource_num",
            "type" : "rdb",
            "db": "resource",
            "sqls" : [
                "update resource set num=num-@{!num} where no='@{no}'"
            ]
        }
    ],
    
    "response":[]
},

{
    "name": "rejectoutbound",
    "method":"DELETE",
    "property" : "private",
    "tokenChecker":"USER",
    "comment":"拒绝资源出库申请",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"出库记录ID"}
    ],

    "process" : [
        {
            "name" : "remove_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                "delete from outbound where id=@{id}"
            ]
        }
    ]
},

{
    "name": "cfmoutbound",
    "method":"PUT",
    "property" : "private",
    "tokenChecker":"USER",
    "comment":"拒绝资源出库申请",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"出库记录ID"}
    ],

    "process" : [
        {
            "name" : "remove_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                "update outbound set
                    cfmDate=@{NOW|unit60000},
                    state='CFM'
                 where id=@{id}"
            ]
        }
    ]
},

{
    "name": "discard",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "comment":"资源报废，资产挂账人先通过入库申请，将资产退回仓库，再由仓库管理员报废",

    "request": [
        {"name":"no", "type":"string", "must":true, "min":1, "comment":"资产编号"},
        {"name":"warehouse", "type":"int", "must":true, "min":0, "comment":"仓库ID"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"数量"}
    ],

    "process" : [
        {
            "name" : "decrease_resource_num",
            "type" : "rdb",
            "db": "resource",
            "sqls" : [{
                "expected":{"num":1,"code":2001,"info":"not exists"},
                "sql":"update resource set num=num-@{num}
                    where no='@{no}' and num>=@{num}"
            }]
        },
        {
            "name" : "decrease_inventory_num",
            "type" : "rdb",
            "db": "common",
            "sqls" : [{
                "expected":{"num":1,"code":2001,"info":"not exists"},
                "sql":"update inventory set num=num-@{num}
                    where no='@{no}' and num>=@{num}"
            }]
        },
        {
            "name" : "discard",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                "insert into discard(no,warehouse,num,at,cfmAcc)
                values('@{no}',@{warehouse},@{num},@{NOW|60000},'@{#tokenAcc}')"
            ]
        }
    ]
}
]