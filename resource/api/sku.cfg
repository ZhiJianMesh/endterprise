[
{
    "name": "list",
    "method":"GET",
    "property" : "public",
    "comment":"查询sku列表",

    "request": [
        {"name":"offset", "type":"int", "must":true, "min":0, "comment":"偏移"},
        {"name":"num", "type":"int",  "must":true, "min":1, "comment":"返回行数"}
    ],

    "process" : [
        {
            "name" : "list_skus",
            "type" : "rdb",
            "db": "common",
            "sqls" : [{
                "name" : "list",
                "metas" : "each",
                "multi" : true,
                "merge" : false,
                "sql":"select s.id,s.price,s.deprRate,s.supplier,s.noHead,
                        p.name sname,s.name,s.speci,s.cmt,s.createAt
                     from sku s,supplier p
                     where p.id=s.id
                     order by s.id
                     LIMIT @{num} OFFSET @{offset}"
            }]
        }
    ]
},

{
    "name": "add",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"admin",
    "comment":"增加SKU",

    "request": [
        {"name":"name", "type":"string", "must":true, "min":1, "comment":"sku名称"},
        {"name":"noHead", "type":"string", "must":true, "min":1, "comment":"资产编号的头部"},
        {"name":"price", "type":"double", "must":true, "min":0.0, "comment":"sku价格"},
        {"name":"deprRate", "type":"float", "must":true, "min":0.0, "comment":"sku年折旧率"},
        {"name":"supplier", "type":"int", "must":true, "min":0, "comment":"供应商ID"},
        {"name":"speci", "type":"string", "must":false, "default":"", "comment":"规格，比如颜色、尺寸、版本、型号等"},
        {"name":"cmt", "type":"string", "must":false, "default":"", "comment":"描述"}
    ],

    "process" : [
        {
            "name" : "add_warehouse",
            "type" : "rdb",
            "db": "common",
            "sqls" : [
                "insert into sku(id,createAt,noHead,price,
                    deprRate,supplier,name,speci,cmt)
                 values(@{SEQUENCE|i,skuid},@{NOW|unit60000},'@{noHead}',@{price},
                    @{deprRate},@{supplier},'@{name}','@{speci}','@{cmt}')"
            ]
        }
    ]
},

{
    "name": "update",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"admin",
    "comment":"修改SKU信息",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"sku ID"},
        {"name":"name", "type":"string", "must":true, "min":1, "comment":"sku名称"},
        {"name":"noHead", "type":"string", "must":true, "min":1, "comment":"资产编号的头部"},
        {"name":"price", "type":"double", "must":true, "min":0.0, "comment":"sku价格"},
        {"name":"deprRate", "type":"float", "must":true, "min":0.0, "comment":"sku年折旧率"},
        {"name":"supplier", "type":"int", "must":true, "min":0, "comment":"供应商ID"},
        {"name":"speci", "type":"string", "must":false, "default":"", "comment":"规格，比如颜色、尺寸、版本、型号等"},
        {"name":"cmt", "type":"string", "must":false, "default":"", "comment":"描述"}
    ],

    "process" : [
        {
            "name" : "update_sku",
            "type" : "rdb",
            "db": "common",
            "sqls" : [
                "update sku set
                    price=@{price},
                    deprRate=@{deprRate},
                    supplier=@{supplier},
                    name='@{name}',
                    noHead='@{noHead}',
                    speci='@{speci}',
                    cmt='@{cmt}'
                  where id=@{id}"
            ]
        }
    ]
},

{
    "name": "remove",
    "method":"DELETE",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"admin",
    "comment":"删除SKU",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"供应商ID"}
    ],

    "process" : [
        {
            "name" : "judge_resource_exists",
            "db" : "resource",
            "type" : "dataexists",
            "expect" : false, //如果存在，则返回EXISTS，否则返回OK
            "errorCode":3003,
            "errorInfo":"there are resource refering to it",
            "sql":"select * from resource where sku=@{id}"
        },
        {
            "name" : "delete_supplier",
            "type" : "rdb",
            "db": "common",
            "sqls" : [
                "delete from sku where id=@{id}",
                "delete from subsku where fid=@{id}"
            ]
        }
    ]
},

{
    "name": "addSub",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"admin",
    "comment":"增加子SKU",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":1, "comment":"sku id"},
        {"name":"subSku", "type":"int", "must":true, "min":1, "comment":"子SKU id"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"子SKU id数量"}
    ],

    "process" : [
        {
            "name" : "add_sub",
            "type" : "rdb",
            "db": "common",
            "sqls" : [
                "insert into subsku(fid,subSku,num) values(@{fid},@{subSku},@{num})"
            ]
        }
    ]
},

{
    "name": "removeSub",
    "method":"DELETE",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"admin",
    "comment":"删除子SKU",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":1, "comment":"sku id"},
        {"name":"subSku", "type":"int", "must":true, "min":1, "comment":"子SKU id"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"删除子SKU id数量"}
    ],

    "process" : [
        {
            "name" : "add_sub",
            "type" : "rdb",
            "db": "common",
            "sqls" : [
                "update subsku set num=num-@{num}
                 where fid=@{id} and subSku=@{subSku}",
                "delete from subsku
                 where fid=@{id} and subSku=@{subSku} and num=0"
            ]
        }
    ]
},

{
    "name": "listSub",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "comment":"查询子SKU",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":1, "comment":"sku id"}
    ],

    "process" : [
        {
            "name" : "list",
            "type" : "rdb",
            "db": "common",
            "sqls":[
                {
                    "name":"list",
                    "metas":"each",
                    "merge":false,
                    "multi":true,
                    "sql":"select S.name,S.speci,S.price,SS.num
                        from subsku SS,sku S
                        where SS.fid=@{id} and S.id=SS.subSku"
                }
            ]
        }
    ]
}
]