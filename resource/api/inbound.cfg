[
{
    "name": "listByWh",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"按仓库查询入库单",

    "request": [
        {"name":"warehouse", "type":"int", "must":true, "min":0, "comment":"仓库ID"},
        {"name":"offset", "type":"int", "must":true, "min":0, "comment":"偏移"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"返回行数"}
    ],

    "process" : [
        {
            "name" : "list_inventory",
            "type" : "rdb",
            "db": "log",
            "sqls" : [{
                "name" : "list",
                "metas" : "each",
                "multi" : true,
                "merge" : false,
                "sql" : "select id,sku,outDate,inDate,type,tranNo,cfmAcc,cmt
                     from inbound where warehouse=@{warehouse}
                     order by inDate desc
                     LIMIT @{num} OFFSET @{offset}"
            }]
        }
    ]
},
{
    "name": "listByTranNo",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"按运单号查询入库单",

    "request": [
        {"name":"tranNo", "type":"string", "must":true, "min":0, "comment":"运单号"},
        {"name":"type", "type":"string", "must":true, "options":["INN","EXT"], "comment":"发货类型"}
    ],

    "process" : [
        {
            "name" : "list_inventory",
            "type" : "rdb",
            "db": "log",
            "sqls" : [{
                "name" : "list",
                "metas" : "each",
                "multi" : true,
                "merge" : false,
                "sql":"select id,sku,outDate,inDate,type,tranNo,cfmAcc,cmt
                     from inbound where tranNo='@{tranNo}' and type='@{type}'
                     order by inDate desc"
            }]
        }
    ]
},

{
    "name": "create",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"创建资源入库单",

    "request": [
        {"name":"warehouse", "type":"int", "must":true, "min":0, "comment":"仓库ID"},
        {"name":"outDate", "type":"int", "must":true, "min":1, "comment":"供应商发货时间"},
        {"name":"type", "type":"string",  "must":true, "options":["INN","EXT"], "comment":"类型"},
        {"name":"tranNo", "type":"string", "must":true, "min":1, "comment":"外部或内部运单号"},
        {"name":"cfmAcc", "type":"string", "must":true, "min":1, "comment":"入库确认人"},
        {"name":"cmt", "type":"string", "must":true, "min":1, "comment":"备注"}
    ],

    "process" : [{
        "name" : "log_inbound",
        "type" : "rdb",
        "db": "log",
        "sqls" : [
            "insert into inbound(warehouse,tranNo,outDate,inDate,type,cfmAcc,cmt)
             values(@{warehouse},'@{tranNo}',@{outDate},@{NOW|unit60000},
                '@{type}','@{#tokenAcc}','@{cmt}')"
        ]
    }]
},

{
    "name": "shipIn",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"执行资源入库，一个sku一条，每次的资产编号不同",

    "request": [
        {"name":"inId", "type":"int", "must":true, "min":0, "comment":"入库单ID"},
        {"name":"sku", "type":"int", "must":true, "min":0, "comment":"sku ID"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"数量"},
        {"name":"price", "type":"double", "must":true, "min":0, "comment":"最新采购价"}
    ],

    "process" : [
        {
            "name" : "get_sku_info",
            "type" : "rdb",
            "db" : "common",
            "comment" : "查询年折旧率，记入resource中，便于每月计算折旧，顺便确认SKU是否存在",
            "sqls" : [{
                "name" : "get_sku_info",
                "metas" : "each",
                "multi" : false,
                "merge" : true,
                "sql" : "select yearDepr,noHead from sku where id=@{sku}"
            }]
        },
        {
            "name" : "get_res_no",
            "type" : "var",
            "toResp" : true,
            "vars":{ //1秒入库超过1万次，no会碰撞，改变SEQUENCE输出位数，可避免碰撞
                "no":"@{!noHead}@{NOW|yyyyMMddHHmmss}@{SEQUENCE|'noid',4}",
                "monthDepr":"js:(@{!yearDepr}*@{price}/12).toFixed(2)"
            }
        },
        {
            "name" : "log_inbound_list",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                {
                    "expected":{"num":1,"code":2001,"info":"inbound not exists"},
                    "insert into inventory(warehouse,tranNo,sku,num,price,no,cmt)
                     select warehouse,tranNo,@{sku},@{num},@{price},'@{no}',cmt
                     from inbound where id=@{inId}"
                },
                "insert into inlist(inId,sku,num,no,price)
                 values(@{inId},@{sku},@{num},'@{no}',@{price})",
            ]
        },
        {
            "name" : "save_resource",
            "type" : "rdb",
            "db": "resource",
            "sqls" : [
                "insert into resource(sku,createAt,num,no,price,monthDepr)
                 values(@{sku},@{NOW|unit60000},@{num},'@{no}',@{price},@{monthDepr})"
            ]
        }
    ]
},

{
    "name": "remove",
    "method":"DELETE",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"删除资源入库单，只有无inlist时才可以删除",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"入库单ID"}
    ],

    "process" : [
        {
            "name" : "judge_inlist_empty_or_not",
            "type":"dataexists",
            "db":"log",
            "expect" : false,
            "errorCode":6004,
            "errorInfo":"inlist is not empty",
            "sql":"select * from inlist where inId=@{id}"
        },
        {
            "name" : "rmv_inbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                "delete from inbound where id=@{id}"
            ]
        }
    ]
},

{
    "name": "forceRemove",
    "method":"DELETE",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"admin",
    "comment":"强制删除资源入库记录，只有服务的超级管理员才可以执行",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"入库单ID"}
    ],

    "process" : [{
        "name" : "rmv_inbound",
        "type" : "rdb",
        "db": "log",
        "sqls" : [
            "delete from inbound where id=@{id}",
            "delete from inlist where inId=@{id}"
        ]
    }]
}
]