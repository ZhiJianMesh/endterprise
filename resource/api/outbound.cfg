[
{
    "name": "listByWh",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"按仓库查询入库单",

    "request": [
        {"name":"warehouse", "type":"int", "must":true, "min":0, "comment":"仓库ID"},
        {"name":"offset", "type":"int", "must":true, "min":0, "comment":"偏移"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"返回行数"}
    ],

    "process" : [
        {
            "name" : "list_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [{
                "name" : "list",
                "metas" : "each",
                "multi" : true,
                "merge" : false,
                "sql":"select i.id,i.expDate,i.state,i.type,i.tranNo,
                        i.applicant,i.applyCmt,i.pid,p.name prjName
                     from inbound i,project p
                      where i.warehouse=@{warehouse} and p.id=i.pid
                     order by i.type,i.expDate desc
                     LIMIT @{num} OFFSET @{offset}"
            }]
        }
    ]
},

{
    "name": "listByPrj",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "comment":"按项目查询入库单，提单人或项目经理可以查看",

    "request": [
        {"name":"pid", "type":"int", "must":true, "min":0, "comment":"项目ID"},
        {"name":"offset", "type":"int", "must":true, "min":0, "comment":"偏移"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"返回行数"}
    ],

    "process" : [
        {
            "name" : "list_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [{
                "name" : "list",
                "metas" : "each",
                "multi" : true,
                "merge" : false,
                "sql":"select i.id,i.expDate,i.state,i.type,i.tranNo,
                        i.applicant,i.applyCmt,i.pid,p.name prjName
                     from inbound i,project p
                      where i.pid=@{pid} and p.id=@{pid}
                      and (i.applicant='@{#tokenAcc}' or i.applicant=p.leader)
                     order by i.type,i.expDate desc
                     LIMIT @{num} OFFSET @{offset}"
            }]
        }
    ]
},

{
    "name": "listByTranNo",
    "method":"GET",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"按入库单号查询入库单，提货时查询",

    "request": [
        {"name":"tranNo", "type":"string", "must":true, "min":0, "comment":"运单号"},
        {"name":"type", "type":"string", "must":true, "options":["INN","EXT"], "comment":"发货类型"}
    ],

    "process" : [
        {
            "name" : "list_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [{
                "name" : "list",
                "metas" : "each",
                "multi" : true,
                "merge" : false,
                "sql":"select i.id,i.expDate,i.state,i.type,i.tranNo,
                        i.applicant,i.applyCmt,i.pid,p.name prjName
                     from inbound i,project p
                     where id.tranNo='@{tranNo}' and i.type='@{type}' and p.id=@{pid}
                     order by i.type,i.expDate desc"
            }]
        }
    ]
},

{
    "name": "apply",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "comment":"资源出库申请",

    "request": [
        {"name":"warehouse", "type":"int", "must":true, "min":0, "comment":"仓库ID"},
        {"name":"pid", "type":"int", "must":true, "min":0, "comment":"项目ID"},
        {"name":"expDate", "type":"int", "must":true, "min":1, "comment":"供应商发货时间"},
        {"name":"type", "type":"string", "must":true, "options":["INN","EXT"], "comment":"发货类型"},
        {"name":"receiver", "type":"string", "must":true, "min":1, "comment":"收件人，包括姓名、地址、电话，内部发货时填内部接收人帐号"},
        {"name":"cmt", "type":"string", "must":true, "min":1, "comment":"备注"},
        {"name":"skus", "type":"object", "list":true, "must":true, "minSize":1, "maxSize":200, "props":[
            {"name":"sku", "type":"int", "must":true, "min":0, "comment":"SKU ID"},
            {"name":"num", "type":"int", "must":true, "min":1, "comment":"数量"},
        ], "comment":"申请出库的资源清单"}
    ],

    "vars":[
        {"name":"id", "type":"string", "val":"@{SEQUENCE|i,outboundid}", "response":true, "comment":"出库id"}
    ],

    "process" : [
        {
            "name" : "save_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                "insert into outbound(id,pid,warehouse,type,expDate,
                    applicant,receiver,applyCmt)
                 values(@{id},@{pid},@{warehouse},'@{type}',@{expDate},
                    '@{#tokenAcc}','@{receiver}','@{cmt}')",

                "js:var skus=@{skus};
                var sqls=['insert into outlist(outId,sku,num,no) values'];
                for(var i in skus) {
                    var s=skus[i];
                    if(i>0) sqls.push(',');
                    sqls.push('(@{id},',s.sku,',',s.num,`,'`,s.no,`')`);
                }
                DB.sql(sqls.join(''));
                "
            ]
        }
    ]
},

{
    "name": "start",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"开始执行资源出库，设置运单号与备注，在执行shipOut之前调用",

    "request": [
        {"name":"outId", "type":"int", "must":true, "min":0, "comment":"出库申请id"},
        {"name":"tranNo", "type":"string", "must":true, "min":1, "comment":"外部运单号或内部提货单号"},
        {"name":"cmt", "type":"string", "must":true, "min":1, "comment":"备注"}
    ],

    "process" : [
        {
            "name" : "save_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                "update outbound set
                    tranNo='@{tranNo}',
                    cmt='@{cmt}',
                    outDate=@{NOW|unit60000},
                    state='TRAN' -- 运输中
                  where id=@{outId} and state='WAIT'"
            ]
        }
    ]
},

{
    "name": "shipOut",
    "method":"POST",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"执行资源出库",

    "request": [
        {"name":"outId", "type":"int", "must":true, "min":0, "comment":"出库申请单ID"},
        {"name":"no", "type":"string", "must":true, "min":1, "comment":"出库资产编号"},
        {"name":"num", "type":"int", "must":true, "min":1, "comment":"数量"}
    ],

    "process" : [
        {
            "name":"judge_outbound_exists_or_not",
            "type":"dataexists",
            "db":"log",
            "expect" : true,
            "errorCode":6005,
            "errorInfo":"invalid state",
            "sql":"select * from outbound where id=@{outId} and state='TRAN'"
        },
        {
            "name" : "update_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                {
                    "expected" : {"num":1, "code":2001, "info":"inventory not enough"},
                    "sql" : "update inventory set num=num-@{num} where no='@{no}' and num>=@{num}"
                },
                "delete from inventory where no='@{no}' and num<=0",

                "insert into outlist(outId,no,sku,num)
                values(@{outId},'@{no}',@{sku},@{num})"
            ]
        },
        {
            "name" : "update_resource_num",
            "type" : "rdb",
            "db": "resource",
            "sqls" : [//不确认数量足够，以inventory为准
                "update resource set num=num-@{num} where no='@{no}'"
            ]
        }
    ]
},

{
    "name": "setState",
    "method":"PUT",
    "property" : "private",
    "tokenChecker":"USER",
    "aclChecker":"RBAC",
    "feature":"whadmin",
    "comment":"外部发货，由发货执行人设置发货的状态",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"出库记录ID"},
        {"name":"at", "type":"int", "must":true, "min":0, "comment":"确认时间"},
        {"name":"state", "type":"string", "must":true, "options":["CFM","LOSS","BACK"], "comment":"发货状态"}
    ],

    "process" : [
        {
            "name" : "remove_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                "update outbound set cfmDate=@{at},state='@{state}'
                   where id=@{id} and execAcc='@{#tokenAcc}'"
            ]
        }
    ]
},

{
    "name": "confirm",
    "method":"PUT",
    "property" : "private",
    "tokenChecker":"USER",
    "comment":"内部发货，可以由接收方确认",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"出库记录ID"}
    ],

    "process" : [
        {
            "name" : "cfm_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                "update outbound set cfmDate=@{NOW|unit60000},state='CFM'
                  where id=@{id} and receiver='@{#tokenAcc}'"
            ]
        }
    ]
},

{
    "name": "remove",
    "method":"DELETE",
    "property" : "private",
    "tokenChecker":"USER",
    "comment":"删除出库申请，提出人才可以删除",

    "request": [
        {"name":"id", "type":"int", "must":true, "min":0, "comment":"出库记录ID"}
    ],

    "process" : [
        {
            "name" : "remove_outbound",
            "type" : "rdb",
            "db": "log",
            "sqls" : [
                "delete from outbound where id=@{id}
                 and applicant='@{#tokenAcc}'
                 and state='WAIT'"
            ]
        }
    ]
}
]